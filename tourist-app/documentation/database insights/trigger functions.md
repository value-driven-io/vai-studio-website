## Actual trigger function definitions (staging) 

[
  {
    "routine_name": "auto_populate_schedule_relationship",
    "routine_definition": "\nBEGIN\n  -- If this is a scheduled tour being created, try to find its parent schedule\n  IF NEW.activity_type = 'scheduled' AND NEW.parent_template_id IS NOT NULL AND NEW.parent_schedule_id IS NULL THEN\n    SELECT s.id INTO NEW.parent_schedule_id\n    FROM public.schedules s \n    WHERE s.tour_id = NEW.parent_template_id\n    ORDER BY s.created_at DESC\n    LIMIT 1;\n  END IF;\n  \n  RETURN NEW;\nEND;\n"
  },
  {
    "routine_name": "auto_set_customization_timestamp",
    "routine_definition": "\nBEGIN\n  -- If tour is being marked as customized, set timestamp\n  IF NEW.is_customized = TRUE AND (OLD.is_customized IS NULL OR OLD.is_customized = FALSE) THEN\n    NEW.customization_timestamp = NOW();\n  END IF;\n  \n  -- If tour is being un-customized, clear timestamp\n  IF NEW.is_customized = FALSE AND OLD.is_customized = TRUE THEN\n    NEW.customization_timestamp = NULL;\n    NEW.frozen_fields = '{}';\n    NEW.overrides = '{}';\n  END IF;\n  \n  RETURN NEW;\nEND;\n"
  },
  {
    "routine_name": "create_booking_notification",
    "routine_definition": "\n  DECLARE\n      tour_name_var TEXT;  -- Renamed from 'tour_name' to avoid column conflict\n  BEGIN\n      -- Only create notification for new bookings, not updates\n      IF TG_OP = 'INSERT' THEN\n          -- Get tour name with explicit table alias to avoid ambiguity\n          SELECT t.tour_name INTO tour_name_var\n          FROM tours t WHERE t.id = NEW.tour_id;\n\n          INSERT INTO public.notifications (\n              operator_id,\n              recipient_type,\n              type,\n              category,\n              title,\n              message,\n              title_i18n,\n              message_i18n,\n              action_type,\n              action_data,\n              source,\n              data\n          ) VALUES (\n              NEW.operator_id,\n              'operator',\n              'booking',\n              'transactional',\n              'New Booking Request',\n              'New booking for ' || COALESCE(tour_name_var, 'your activity'),\n              -- Multilingual titles\n              jsonb_build_object(\n                  'en', 'New Booking Request',\n                  'fr', 'Nouvelle Demande de Réservation'\n              ),\n              -- Multilingual messages  \n              jsonb_build_object(\n                  'en', 'New booking for ' || COALESCE(tour_name_var, 'your activity'),\n                  'fr', 'Nouvelle réservation pour ' || COALESCE(tour_name_var, 'votre activité')\n              ),\n              'navigate',\n              jsonb_build_object('tab', 'bookings', 'bookingId', NEW.id),\n              'trigger',\n              jsonb_build_object(\n                  'bookingId', NEW.id,\n                  'tourId', NEW.tour_id,\n                  'bookingReference', NEW.booking_reference,\n                  'customerName', NEW.customer_name,\n                  'activityName', COALESCE(tour_name_var, 'Unknown Activity')\n              )\n          );\n\n          RAISE LOG 'Created multilingual booking notification for operator % booking %', NEW.operator_id, NEW.id;\n      END IF;\n\n      RETURN NEW;\n  END;\n  "
  },
  {
    "routine_name": "trigger_booking_webhook",
    "routine_definition": "\nDECLARE\n    webhook_url TEXT;\n    webhook_payload JSONB;\n    booking_data JSONB;\n    tourist_data JSONB;\n    tour_data JSONB;\n    operator_data JSONB;\n    webhook_event TEXT;\n    should_trigger BOOLEAN := false;\nBEGIN\n    -- Determine if we should trigger webhook and what type\n    IF TG_OP = 'INSERT' THEN\n        should_trigger := true;\n        webhook_event := 'booking_created';\n        webhook_url := 'https://n8n-stable-latest.onrender.com/webhook/new-booking-notification';\n    ELSIF TG_OP = 'UPDATE' THEN\n        -- Only trigger on important field changes\n        IF (OLD.booking_status != NEW.booking_status OR\n            OLD.payment_status != NEW.payment_status OR\n            OLD.num_adults != NEW.num_adults OR\n            OLD.num_children != NEW.num_children) THEN\n            \n            should_trigger := true;\n            \n            -- Determine event type based on what changed\n            IF OLD.booking_status != NEW.booking_status THEN\n                CASE NEW.booking_status\n                    WHEN 'confirmed' THEN \n                        webhook_event := 'booking_confirmed';\n                        webhook_url := 'https://n8n-stable-latest.onrender.com/webhook/booking-confirmed';\n                    WHEN 'declined' THEN \n                        webhook_event := 'booking_declined';\n                        webhook_url := 'https://n8n-stable-latest.onrender.com/webhook/booking-declined';\n                    WHEN 'cancelled' THEN \n                        webhook_event := 'booking_cancelled';\n                        webhook_url := 'https://n8n-stable-latest.onrender.com/webhook/booking-cancelled';\n                    WHEN 'completed' THEN \n                        webhook_event := 'booking_completed';\n                        webhook_url := 'https://n8n-stable-latest.onrender.com/webhook/booking-completed';\n                    ELSE\n                        should_trigger := false;\n                END CASE;\n            ELSIF OLD.payment_status != NEW.payment_status THEN\n                webhook_event := 'payment_status_changed';\n                webhook_url := 'https://n8n-stable-latest.onrender.com/webhook/payment-status-changed';\n            ELSIF (OLD.num_adults != NEW.num_adults OR OLD.num_children != NEW.num_children) THEN\n                webhook_event := 'booking_participants_changed';\n                webhook_url := 'https://n8n-stable-latest.onrender.com/webhook/booking-participants-changed';\n            END IF;\n        END IF;\n    END IF;\n\n    -- Exit early if no webhook should be triggered\n    IF NOT should_trigger THEN\n        RETURN NEW;\n    END IF;\n\n    -- Get selective booking data (exclude internal tracking fields)\n    SELECT to_jsonb(booking_info.*) INTO booking_data\n    FROM (\n        SELECT \n            b.id,\n            b.created_at,\n            b.updated_at,\n            b.tour_id,\n            b.operator_id,\n            b.customer_name,\n            b.customer_email,\n            b.customer_phone,\n            b.customer_whatsapp,\n            b.num_adults,\n            b.num_children,\n            b.total_participants,\n            b.adult_price,\n            b.child_price,\n            b.subtotal,\n            b.commission_amount,\n            b.total_amount,\n            b.special_requirements,\n            b.dietary_restrictions,\n            b.accessibility_needs,\n            b.booking_status,\n            b.payment_status,\n            b.confirmation_deadline,\n            b.confirmed_at,\n            b.cancelled_at,\n            b.operator_response,\n            b.booking_reference,\n            b.decline_reason,\n            b.user_id,  -- Keep for n8n write-back capability\n            b.tourist_user_id,\n            -- Add calculated fields that n8n might need\n            EXTRACT(EPOCH FROM (b.confirmation_deadline - NOW()))/3600 as hours_until_timeout\n        FROM bookings b \n        WHERE b.id = COALESCE(NEW.id, OLD.id)\n    ) booking_info;\n\n    -- Get tourist data with language preference\n    SELECT to_jsonb(tourist_info.*) INTO tourist_data\n    FROM (\n        SELECT \n            tu.id,\n            tu.email,\n            tu.first_name,\n            tu.last_name,\n            tu.whatsapp_number,\n            tu.phone,\n            tu.preferred_language,  -- KEY for email language\n            tu.marketing_emails,\n            tu.email_verified,\n            tu.status,\n            tu.created_at\n        FROM tourist_users tu \n        WHERE tu.id = COALESCE(NEW.tourist_user_id, OLD.tourist_user_id)\n    ) tourist_info;\n\n    -- Get tour data with available languages\n    SELECT to_jsonb(tour_info.*) INTO tour_data\n    FROM (\n        SELECT \n            t.id,\n            t.tour_name,\n            t.tour_type,\n            t.description,\n            t.tour_date,\n            t.time_slot,\n            t.duration_hours,\n            t.meeting_point,\n            t.max_capacity,\n            t.available_spots,\n            t.original_price_adult,\n            t.discount_price_adult,\n            t.discount_price_child,\n            t.languages,  -- Available tour languages\n            t.pickup_available,\n            t.pickup_locations,\n            t.equipment_included,\n            t.food_included,\n            t.drinks_included,\n            t.weather_dependent,\n            t.backup_plan,\n            t.special_notes\n        FROM tours t \n        WHERE t.id = COALESCE(NEW.tour_id, OLD.tour_id)\n    ) tour_info;\n\n    -- Get operator data with language extraction from notes\n    SELECT to_jsonb(operator_info.*) INTO operator_data\n    FROM (\n        SELECT \n            o.id,\n            o.company_name,\n            o.contact_person,\n            o.email,\n            o.whatsapp_number,\n            o.phone,\n            o.island,\n            o.business_description,\n            o.commission_rate,\n            -- Extract language from notes JSON, fallback to new field, then default to 'fr'\n            COALESCE(\n                o.preferred_language,  -- New dedicated field (if populated)\n                o.notes::jsonb->>'primary_language',  -- Extract from JSON notes\n                'fr'  -- Default fallback\n            ) as preferred_language\n        FROM operators o \n        WHERE o.id = COALESCE(NEW.operator_id, OLD.operator_id)\n    ) operator_info;\n\n    -- Build comprehensive webhook payload\n    webhook_payload := jsonb_build_object(\n        'event', webhook_event,\n        'timestamp', NOW(),\n        'booking_id', COALESCE(NEW.id, OLD.id),\n        'booking', booking_data,\n        'tourist', tourist_data,\n        'tour', tour_data,\n        'operator', operator_data\n    );\n\n    -- Make HTTP request to n8n webhook (using pg_net extension)\n    PERFORM\n        net.http_post(\n            url := webhook_url,\n            headers := '{\"Content-Type\": \"application/json\"}'::jsonb,\n            body := webhook_payload\n        );\n\n    -- Update webhook tracking (only for booking_created)\n    IF webhook_event = 'booking_created' THEN\n        NEW.webhook_sent := true;\n    END IF;\n\n    RETURN NEW;\nEND;\n"
  }
]

