## VIEW: activity_templates_view

[
  {
    "pg_get_viewdef": " SELECT t.id,\n    t.created_at,\n    t.updated_at,\n    t.operator_id,\n    t.tour_name,\n    t.tour_type,\n    t.description,\n    t.tour_date,\n    t.time_slot,\n    t.duration_hours,\n    t.max_capacity,\n    t.available_spots,\n    t.original_price_adult,\n    t.discount_price_adult,\n    t.discount_price_child,\n    t.discount_percentage,\n    t.meeting_point,\n    t.meeting_point_gps,\n    t.pickup_available,\n    t.pickup_locations,\n    t.languages,\n    t.equipment_included,\n    t.food_included,\n    t.drinks_included,\n    t.whale_regulation_compliant,\n    t.max_whale_group_size,\n    t.min_age,\n    t.max_age,\n    t.fitness_level,\n    t.requirements,\n    t.restrictions,\n    t.booking_deadline,\n    t.auto_close_hours,\n    t.status,\n    t.weather_dependent,\n    t.backup_plan,\n    t.special_notes,\n    t.created_by_operator,\n    t.location,\n    t.activity_type,\n    t.is_template,\n    t.parent_template_id,\n    t.recurrence_data,\n    t.template_cover_image,\n    o.company_name,\n    o.operator_logo,\n    o.average_rating AS operator_average_rating,\n    o.total_tours_completed AS operator_total_tours_completed\n   FROM tours t\n     LEFT JOIN operators o ON t.operator_id = o.id\n  WHERE t.is_template = true;"
  }
]

## VIEW: active_tours_with_operators

[
  {
    "pg_get_viewdef": " SELECT t.id,\n    t.created_at,\n    t.updated_at,\n    t.operator_id,\n    t.tour_name,\n    t.tour_type,\n    t.description,\n    t.tour_date,\n    t.time_slot,\n    t.duration_hours,\n    t.max_capacity,\n    t.available_spots,\n    t.original_price_adult,\n    t.discount_price_adult,\n    t.discount_price_child,\n    t.discount_percentage,\n    t.meeting_point,\n    t.meeting_point_gps,\n    t.pickup_available,\n    t.pickup_locations,\n    t.languages,\n    t.equipment_included,\n    t.food_included,\n    t.drinks_included,\n    t.whale_regulation_compliant,\n    t.max_whale_group_size,\n    t.min_age,\n    t.max_age,\n    t.fitness_level,\n    t.requirements,\n    t.restrictions,\n    t.booking_deadline,\n    t.auto_close_hours,\n    t.status,\n    t.weather_dependent,\n    t.backup_plan,\n    t.special_notes,\n    t.location,\n    t.activity_type,\n    t.is_template,\n    t.parent_template_id,\n    t.parent_schedule_id,\n    t.is_customized,\n    t.frozen_fields,\n    t.overrides,\n    t.is_detached,\n    t.promo_discount_percent,\n    t.promo_discount_value,\n    t.instance_note,\n    t.customization_timestamp,\n    t.max_age_child,\n    t.discount_percentage_child,\n    t.detached_from_schedule_id,\n    COALESCE((t.overrides ->> 'discount_price_adult'::text)::integer, t.discount_price_adult) AS effective_discount_price_adult,\n    COALESCE((t.overrides ->> 'discount_price_child'::text)::integer, t.discount_price_child) AS effective_discount_price_child,\n    COALESCE((t.overrides ->> 'max_capacity'::text)::integer, t.max_capacity) AS effective_max_capacity,\n    COALESCE((t.overrides ->> 'available_spots'::text)::integer, t.available_spots) AS effective_available_spots,\n    COALESCE(t.overrides ->> 'meeting_point'::text, t.meeting_point::text) AS effective_meeting_point,\n        CASE\n            WHEN t.promo_discount_percent IS NOT NULL OR t.promo_discount_value IS NOT NULL THEN true\n            ELSE false\n        END AS has_promotional_pricing,\n        CASE\n            WHEN t.promo_discount_percent IS NOT NULL THEN round((t.discount_price_adult * t.promo_discount_percent)::numeric / 100.0)\n            WHEN t.promo_discount_value IS NOT NULL THEN t.promo_discount_value::numeric\n            ELSE 0::numeric\n        END AS promotional_discount_amount,\n        CASE\n            WHEN t.promo_discount_percent IS NOT NULL THEN t.discount_price_adult::numeric - round((t.discount_price_adult * t.promo_discount_percent)::numeric / 100.0)\n            WHEN t.promo_discount_value IS NOT NULL THEN GREATEST(0, t.discount_price_adult - t.promo_discount_value)::numeric\n            ELSE COALESCE((t.overrides ->> 'discount_price_adult'::text)::integer, t.discount_price_adult)::numeric\n        END AS final_price_adult,\n    template.tour_name AS template_name,\n    template.tour_type AS template_type,\n    template.description AS template_description,\n    template.id AS template_id,\n    s.recurrence_type,\n    s.days_of_week AS schedule_days,\n    s.start_time AS schedule_start_time,\n    s.start_date AS schedule_start_date,\n    s.end_date AS schedule_end_date,\n    s.is_paused AS schedule_paused,\n    s.schedule_type,\n    o.company_name,\n    o.contact_person,\n    o.email AS operator_email,\n    o.phone AS operator_phone,\n    o.whatsapp_number AS operator_whatsapp_number,\n    o.island AS operator_island,\n    o.address AS operator_address,\n    o.business_license,\n    o.insurance_certificate,\n    o.whale_tour_certified,\n    o.status AS operator_status,\n    o.commission_rate,\n    o.average_rating AS operator_average_rating,\n    o.total_tours_completed AS operator_total_tours_completed,\n    o.business_description AS operator_bio,\n    o.preferred_language AS operator_language,\n    o.operator_logo\n   FROM tours t\n     LEFT JOIN tours template ON t.parent_template_id = template.id AND template.is_template = true\n     LEFT JOIN schedules s ON t.parent_schedule_id = s.id\n     LEFT JOIN operators o ON t.operator_id = o.id\n  WHERE t.is_template = false AND (t.status::text = ANY (ARRAY['active'::character varying::text, 'sold_out'::character varying::text])) AND (s.is_paused = false OR s.is_paused IS NULL OR t.is_detached = true) AND o.status::text = 'active'::text\n  ORDER BY t.tour_date, t.time_slot;"
  }
]

## VIEW: scheduled_activities_view

[
  {
    "pg_get_viewdef": " SELECT id,\n    created_at,\n    updated_at,\n    operator_id,\n    tour_name,\n    tour_type,\n    description,\n    tour_date,\n    time_slot,\n    duration_hours,\n    max_capacity,\n    available_spots,\n    original_price_adult,\n    discount_price_adult,\n    discount_price_child,\n    discount_percentage,\n    meeting_point,\n    meeting_point_gps,\n    pickup_available,\n    pickup_locations,\n    languages,\n    equipment_included,\n    food_included,\n    drinks_included,\n    whale_regulation_compliant,\n    max_whale_group_size,\n    min_age,\n    max_age,\n    fitness_level,\n    requirements,\n    restrictions,\n    booking_deadline,\n    auto_close_hours,\n    status,\n    weather_dependent,\n    backup_plan,\n    special_notes,\n    created_by_operator,\n    location,\n    activity_type,\n    is_template,\n    parent_template_id,\n    recurrence_data\n   FROM tours\n  WHERE activity_type::text = 'scheduled'::text AND status::text = 'active'::text\n  ORDER BY tour_date, time_slot;"
  }
]

## VIEW: tour_management_dashboard

[
  {
    "pg_get_viewdef": " SELECT t.id,\n    t.tour_name,\n    t.tour_type,\n    t.tour_date,\n    t.time_slot,\n    t.activity_type,\n    t.status,\n    t.max_capacity,\n    t.available_spots,\n    t.discount_price_adult,\n    t.discount_price_child,\n    t.original_price_adult,\n    t.is_customized,\n    t.is_detached,\n    t.frozen_fields,\n    t.customization_timestamp,\n    t.instance_note,\n    t.promo_discount_percent,\n    t.promo_discount_value,\n        CASE\n            WHEN t.promo_discount_percent IS NOT NULL THEN t.original_price_adult - t.original_price_adult * t.promo_discount_percent / 100\n            WHEN t.promo_discount_value IS NOT NULL THEN t.original_price_adult - t.promo_discount_value\n            ELSE t.discount_price_adult\n        END AS effective_price_adult,\n    t.parent_template_id,\n    t.parent_schedule_id,\n    template.tour_name AS template_name,\n    s.recurrence_type,\n    s.start_date AS schedule_start_date,\n    s.end_date AS schedule_end_date,\n    t.operator_id,\n    o.company_name,\n        CASE\n            WHEN t.is_detached THEN 'Detached'::text\n            WHEN t.is_customized THEN 'Customized'::text\n            WHEN t.activity_type::text = 'template'::text THEN 'Template'::text\n            WHEN t.activity_type::text = 'scheduled'::text THEN 'Scheduled'::text\n            ELSE 'Last Minute'::text\n        END AS management_status,\n        CASE\n            WHEN array_length(t.frozen_fields, 1) > 0 THEN 'Frozen: '::text || array_to_string(t.frozen_fields, ', '::text)\n            ELSE NULL::text\n        END AS frozen_fields_summary\n   FROM tours t\n     LEFT JOIN tours template ON t.parent_template_id = template.id\n     LEFT JOIN schedules s ON t.parent_schedule_id = s.id\n     LEFT JOIN operators o ON t.operator_id = o.id\n  WHERE t.is_template = false\n  ORDER BY t.tour_date DESC, t.time_slot;"
  }
]

## VIEW: schedule_details

[
  {
    "pg_get_viewdef": " SELECT s.id,\n    s.operator_id,\n    s.schedule_type,\n    s.recurrence_type,\n    s.days_of_week,\n    s.start_time,\n    s.start_date,\n    s.end_date,\n    s.exceptions,\n    s.created_at,\n    s.updated_at,\n    t.id AS template_id,\n    t.tour_name AS template_name,\n    t.tour_type AS template_type,\n    t.max_capacity AS template_capacity,\n    t.discount_price_adult AS template_price,\n    t.auto_close_hours,\n    t.location AS template_location,\n    t.status AS template_status\n   FROM schedules s\n     JOIN tours t ON s.template_id = t.id AND t.is_template = true;"
  }
]